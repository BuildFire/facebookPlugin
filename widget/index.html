<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>widget</title>
    <script type="text/javascript" src="../../../scripts/angular/angular.min.js"></script>
    <script type="text/javascript" src="../../../scripts/buildfire.js"></script>
    <style>
        div.link-verified {
            height: 100%;
            min-height: 300px;
            position: relative;
            display: none;
        }

        /* 1 */
        div.link-verified > div {
            margin: 0;
            position: absolute; /* 2 */
            top: 50%; /* 3 */
            transform: translate(0, -50%);
            width: 100%;
        }

        div.link-verified .glyphicon {
            border: 2px solid;
            padding: 10px;
            border-radius: 50%;
            margin-bottom: 20px;
        }

        #fb-main-container,
        #fb-main-container span,
        #fb-main-container iframe {
            width: 100% !important;
            height: 100% !important;
        }
    </style>
</head>
<body>
<div id="fb-root"></div>
<div class="text-center link-verified">
    <div class="col-md-12">
        <span class="glyphicon glyphicon-ok" aria-hidden="true"></span>
        <p>
            We were able to verify the link you provided. The link will only appear on your mobile device.
        </p>
    </div>
</div>
<script>
    buildfire.spinner.show();

    function getFacebookURLType(url) {
        const checkVideo = /^https?:\/\/.*\.facebook\.com.*\/(video(s)?|watch|story)(\.php?|\/).+$/gm;
        const checkPage = /^https?:\/\/.*\.facebook\.com\/(pg\/)?[a-zA-Z0-9.]+(\/)?$/gm;
        const checkGroup = /^https?:\/\/.*\.facebook\.com\/groups\/[a-zA-Z0-9.]+(\/)?$/gm;
        const checkPostInGroup = /^https?:\/\/.*\.facebook\.com\/groups\/[a-zA-Z0-9.]+\/[a-zA-Z0-9.]+\/[a-zA-Z0-9.]+(\/)?$/gm;
        const checkPost = /^https?:\/\/.*\.facebook\.com\/[a-zA-Z0-9.]+\/posts\/[0-9]+(\/)?$/gm;

        if (checkVideo.test(url)) return 'video';
        else if (checkGroup.test(url)) return 'group';
        else if (checkPage.test(url)) return 'page';
        else if (checkPost.test(url) || checkPostInGroup.test(url)) return 'post';
        else return null;
    }

    function initFacebookPlugin(facebookURL) {
        const facebookURLType = getFacebookURLType(facebookURL);
        if (facebookURLType === 'video') {
            facebookPlugin.className = "fb-video";
            facebookPlugin.setAttribute("data-show-text", "true");
        } else if (facebookURLType === 'post') {
            facebookPlugin.className = "fb-post";
            facebookPlugin.setAttribute("data-show-text", "true");
        } else if (facebookURLType === 'group') {
            facebookPlugin.className = "fb-group";
            facebookPlugin.setAttribute("data-tabs", "timeline");
            facebookPlugin.setAttribute("data-show-metadata", "true");
        } else if (facebookURLType === 'page'){
            facebookPlugin.className = "fb-page";
            facebookPlugin.setAttribute("data-tabs", "timeline");
        } else {
            return; // Invalid URL
        }

        const dataContainer = document.querySelector(".link-verified");
        const body = document.body;

        dataContainer.style.display = "none";

        const facebookSDKScript = document.createElement("script");
        facebookSDKScript.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v19.0";
        facebookSDKScript.async = true;
        facebookSDKScript.defer = true;
        facebookSDKScript.crossOrigin = "anonymous";
        facebookSDKScript.nonce = "mx0cQckN";

        const facebookPlugin = document.createElement("div");
        facebookPlugin.setAttribute("data-href", facebookURL);
        facebookPlugin.setAttribute("data-width", body.clientWidth);
        facebookPlugin.setAttribute("data-height", body.clientHeight);
        facebookPlugin.id = "fb-main-container";

        document.body.appendChild(facebookSDKScript);
        document.body.appendChild(facebookPlugin);
    }

    function dataLoadedHandler(result) {
        var content = null;
        if (result && result.data && !angular.equals({}, result.data)) {
            if (result.data.content) {
                content = result.data.content;
            } else if(!result.id && !result.data.content) {
                content = {
                    facebookId: "https://www.facebook.com/zuck"
                }
            }
        } else {
            content = {
                facebookId: "https://www.facebook.com/zuck"
            };
        }
        buildfire.spinner.hide();
        buildfire.getContext(function (err, context) {
            if (context.device.platform != "web" ) {
                initFacebookPlugin(content.facebookId);
            } else {
                if( buildfire.context.liveMode=="0")//CP
                    document.querySelector(".link-verified").style.display = "block";
                else//HTML5 Version
                    buildfire.navigation.openWindow(content.facebookId, "_system");
            }
        });
    }
    /*
     * Go pull saved data
     * */
    var loadData = function () {
        buildfire.datastore.get(function (err, result) {
            if (err) {
                console.error("Error: ", err);
                buildfire.spinner.hide();

            } else {
                dataLoadedHandler(result);
            }
        });
    }

    loadData();

    /**
     * when a refresh is triggered get reload data
     */
    buildfire.datastore.onRefresh(loadData);

    buildfire.datastore.onUpdate(function (result) {
        dataLoadedHandler(result);
    });
</script>
</body>

</html>